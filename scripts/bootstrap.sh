#!/usr/bin/env bash
set -euo pipefail

# Interactive setup for Neural Forge MCP stack
# - Prompts for credentials and DB choice
# - Writes .env
# - Brings up Docker Compose stack
# - Initializes database (for SQLite today; Postgres migration coming next)

ROOT_DIR=$(cd "$(dirname "$0")/.." && pwd)
ENV_FILE="$ROOT_DIR/.env"

say() { echo -e "\n==> $*\n"; }
ask() { local prompt="$1"; local var; read -rp "$prompt" var; echo "$var"; }

say "Neural Forge MCP bootstrap"

MCP_TOKEN=${MCP_TOKEN:-}
if [[ -z "${MCP_TOKEN}" ]]; then
  MCP_TOKEN=$(ask "Enter MCP_TOKEN (default: dev): ")
  MCP_TOKEN=${MCP_TOKEN:-dev}
fi

# Default to PostgreSQL for real usage
PG_HOST=${PG_HOST:-postgres}
PG_PORT=${PG_PORT:-5432}
PG_DB=${PG_DB:-neural_forge}
PG_USER=${PG_USER:-forge}
PG_PASS=${PG_PASS:-forge}
echo "Configure PostgreSQL (press Enter to accept defaults):"
PG_HOST=$(ask "PG_HOST (default: $PG_HOST): ") || true; PG_HOST=${PG_HOST:-postgres}
PG_PORT=$(ask "PG_PORT (default: $PG_PORT): ") || true; PG_PORT=${PG_PORT:-5432}
PG_DB=$(ask "PG_DB (default: $PG_DB): ") || true; PG_DB=${PG_DB:-neural_forge}
PG_USER=$(ask "PG_USER (default: $PG_USER): ") || true; PG_USER=${PG_USER:-forge}
PG_PASS=$(ask "PG_PASS (default: $PG_PASS): ") || true; PG_PASS=${PG_PASS:-forge}
DATABASE_URL="postgresql+asyncpg://$PG_USER:$PG_PASS@$PG_HOST:$PG_PORT/$PG_DB"
MCP_DB_PATH="data/mcp.db" # retained for local tests; runtime will use DATABASE_URL soon

say "Writing .env"
cat > "$ENV_FILE" <<ENV
# Generated by scripts/bootstrap.sh
MCP_TOKEN=$MCP_TOKEN
MCP_DB_PATH=$MCP_DB_PATH
DATABASE_URL=$DATABASE_URL
# Postgres (compose defaults)
POSTGRES_DB=${PG_DB:-neural_forge}
POSTGRES_USER=${PG_USER:-forge}
POSTGRES_PASSWORD=${PG_PASS:-forge}
ENV

say "Starting Docker Compose stack"
( cd "$ROOT_DIR" && docker compose up -d )

say "Waiting for Postgres to be healthy"
for i in {1..30}; do
  if docker ps --format '{{.Names}} {{.Status}}' | grep -q 'nf-postgres.*(healthy)'; then
    break
  fi
  sleep 2
done

say "Applying database migrations (Alembic)"
if command -v alembic >/dev/null 2>&1; then
  ( cd "$ROOT_DIR" && DATABASE_URL="$DATABASE_URL" alembic upgrade head )
else
  say "Alembic not found; applying raw pg_schema.sql as fallback"
  docker exec -i nf-postgres psql -U "$PG_USER" -d "$PG_DB" -v ON_ERROR_STOP=1 < "$ROOT_DIR/server/db/pg_schema.sql"
fi

say "Initializing SQLite (for local tests only)"
python3 "$ROOT_DIR/server/db/init_db.py" --db "$ROOT_DIR/$MCP_DB_PATH" --schema "$ROOT_DIR/server/db/schema.sql" || true

say "Validating MCP server"
BASE="http://127.0.0.1:8081"
curl -fsS "$BASE/get_capabilities" -H "Authorization: Bearer $MCP_TOKEN" >/dev/null && echo "MCP is up at $BASE"

echo "\nDone. Connect to MCP using:"
echo "  URL: $BASE"
echo "  Bearer token: $MCP_TOKEN"
echo "Prometheus: http://localhost:9090"
echo "Grafana:    http://localhost:3000 (anonymous)"
echo "\nWindsurf/Cursor config snippet (paste into: $HOME/.codeium/windsurf/mcp_config.json):"
cat <<JSON
{
  "mcpServers": {
    "neural-forge": {
      "serverUrl": "${BASE}/sse?token=${MCP_TOKEN}",
      "env": { "MCP_TOKEN": "${MCP_TOKEN}" }
    }
  }
}
JSON

echo "\nAlternative (uses npx supergateway to proxy SSE; requires Node.js/npm):"
cat <<JSON
{
  "mcpServers": {
    "neural-forge": {
      "command": "npx",
      "args": ["-y", "supergateway", "--sse", "${BASE}/sse?token=${MCP_TOKEN}"]
    }
  }
}
JSON
